---
- name: "Setup AUR helper user"
  user:
    name: aur_builder
    group: wheel
- name: "Make sure aur_builder can run pacman with passwordless sudo"
  lineinfile:
    path: /etc/sudoers.d/50-aur_builder-pacman
    line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
    create: yes
    validate: 'visudo -cf %s'
- name: "Install AUR helper"
  include_role:
    name: aur-install
  vars:
    aur_packages: paru
- name: "Install basic packages"
  include_role:
    name: aur-install
  vars:
    aur_packages: "{{ basic_packages }}"
- name: "Setup dropin config folder for pacman"
  file:
    path: /etc/pacman.d/confs
    state: directory
    mode: '0755'
- name: "Allow dropin files for pacman.conf"
  blockinfile:
    path: /etc/pacman.conf
    insertbefore: EOF
    block: |
      # Custom options
      [options]
      Include = /etc/pacman.d/confs/*.conf
- name: "Install pacman dropin files"
  copy:
    src: "{{ item.path }}/{{ item.name }}"
    dest: "/{{ item.path }}/"
    mode: "{{ item.mode }}"
  loop:
    - { name: "no-db-sig.conf", path: "etc/pacman.d/confs", mode: "0644" }
    - { name: "fancy.conf", path: "etc/pacman.d/confs", mode: "0644" }
    - { name: "parallel.conf", path: "etc/pacman.d/confs", mode: "0644" }

- name: "Enable parallel build for makepkg"
  lineinfile:
    path: /etc/makepkg.conf
    regexp: "^MAKEFLAGS"
    insertafter: "^#MAKEFLAGS"
    line: 'MAKEFLAGS="-j$(nproc)"'
    state: present
- name: "Use in memory build dir for makepkg"
  lineinfile:
    path: /etc/makepkg.conf
    regexp: "^BUILDDIR"
    insertafter: "^#BUILDDIR"
    line: 'BUILDDIR=/tmp/makepkg'
    state: present
- name: "Set packager for makepkg"
  lineinfile:
    path: /etc/makepkg.conf
    regexp: "^PACKAGER"
    insertafter: "^#PACKAGER"
    line: 'PACKAGER="Aetf <aetf@unlimited-code.works>"'
    state: present
